{
  "info": {
    "name": "FintechPSP - Transações Cliente",
    "description": "Collection para transacionar como cliente - Fluxo completo do cadastro até transações PIX",
    "version": "1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:5000",
      "description": "URL base do API Gateway"
    },
    {
      "key": "admin_token",
      "value": "",
      "description": "Token de admin (BackofficeWeb)"
    },
    {
      "key": "client_token", 
      "value": "",
      "description": "Token de cliente (InternetBankingWeb)"
    },
    {
      "key": "company_id",
      "value": "",
      "description": "ID da empresa criada"
    },
    {
      "key": "user_id",
      "value": "",
      "description": "ID do usuário cliente"
    },
    {
      "key": "qr_code_id",
      "value": "",
      "description": "ID do QR Code PIX"
    }
  ],
  "event": [
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Auto-extract tokens and IDs from responses",
          "if (pm.response.code >= 200 && pm.response.code < 300) {",
          "    try {",
          "        const response = pm.response.json();",
          "        ",
          "        // Extract tokens",
          "        if (response.accessToken) {",
          "            if (pm.request.name.includes('Admin')) {",
          "                pm.collectionVariables.set('admin_token', response.accessToken);",
          "                console.log('🔑 Admin token saved');",
          "            } else {",
          "                pm.collectionVariables.set('client_token', response.accessToken);",
          "                console.log('🔑 Client token saved');",
          "            }",
          "        }",
          "        ",
          "        // Extract IDs",
          "        if (response.id) {",
          "            if (pm.request.url.toString().includes('companies')) {",
          "                pm.collectionVariables.set('company_id', response.id);",
          "                console.log('🏢 Company ID saved:', response.id);",
          "            } else if (pm.request.url.toString().includes('users')) {",
          "                pm.collectionVariables.set('user_id', response.id);",
          "                console.log('👤 User ID saved:', response.id);",
          "            } else if (pm.request.url.toString().includes('qrcode')) {",
          "                pm.collectionVariables.set('qr_code_id', response.id);",
          "                console.log('📱 QR Code ID saved:', response.id);",
          "            }",
          "        }",
          "    } catch (e) {",
          "        console.log('Response parsing error:', e);",
          "    }",
          "}",
          "",
          "// Test status",
          "pm.test('Request successful', function () {",
          "    pm.expect(pm.response.code).to.be.oneOf([200, 201, 202]);",
          "});"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "🔐 1. AUTENTICAÇÃO",
      "item": [
        {
          "name": "1.1 Login Admin",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@fintechpsp.com\",\n  \"password\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/login",
              "host": ["{{base_url}}"],
              "path": ["auth", "login"]
            }
          }
        },
        {
          "name": "1.2 Login Cliente",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"cliente@empresateste.com\",\n  \"password\": \"123456\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/login",
              "host": ["{{base_url}}"],
              "path": ["auth", "login"]
            }
          }
        },
        {
          "name": "1.3 Verificar Dados do Cliente (/client-users/me)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/client-users/me",
              "host": ["{{base_url}}"],
              "path": ["client-users", "me"]
            },
            "description": "Endpoint usado pelo InternetBankingWeb para obter dados do usuário atual"
          }
        }
      ]
    },
    {
      "name": "🏢 2. EMPRESAS (Admin)",
      "item": [
        {
          "name": "2.1 Criar Empresa",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{admin_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"razaoSocial\": \"EmpresaTeste Ltda\",\n  \"nomeFantasia\": \"EmpresaTeste\",\n  \"cnpj\": \"12.345.678/0001-99\",\n  \"email\": \"contato@empresateste.com\",\n  \"telefone\": \"(11) 99999-9999\",\n  \"address\": {\n    \"street\": \"Rua Teste, 123\",\n    \"city\": \"São Paulo\",\n    \"state\": \"SP\",\n    \"zipCode\": \"01234-567\",\n    \"country\": \"Brasil\"\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/companies",
              "host": ["{{base_url}}"],
              "path": ["admin", "companies"]
            }
          }
        },
        {
          "name": "2.2 Aprovar Empresa",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{admin_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"status\": \"Approved\",\n  \"observacoes\": \"Empresa aprovada para operação\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/companies/{{company_id}}/status",
              "host": ["{{base_url}}"],
              "path": ["admin", "companies", "{{company_id}}", "status"]
            }
          }
        }
      ]
    },
    {
      "name": "👤 3. USUÁRIOS (Admin)",
      "item": [
        {
          "name": "3.1 Criar Usuário Cliente (com senha)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{admin_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Cliente EmpresaTeste\",\n  \"email\": \"cliente@empresateste.com\",\n  \"password\": \"123456\",\n  \"role\": \"cliente\",\n  \"isActive\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/users",
              "host": ["{{base_url}}"],
              "path": ["admin", "users"]
            },
            "description": "Criar usuário com senha - ENDPOINT CORRETO para criar usuários que podem fazer login"
          }
        }
      ]
    },
    {
      "name": "💰 4. TRANSAÇÕES PIX (Cliente)",
      "item": [
        {
          "name": "4.1 Gerar QR Code PIX Dinâmico",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"externalId\": \"QR-DYNAMIC-{{$randomUUID}}\",\n  \"amount\": 100.50,\n  \"pixKey\": \"cliente@empresateste.com\",\n  \"bankCode\": \"756\",\n  \"description\": \"Teste PIX - Cobrança dinâmica\",\n  \"expiresIn\": 3600\n}"
            },
            "url": {
              "raw": "{{base_url}}/transacoes/pix/qrcode/dinamico",
              "host": ["{{base_url}}"],
              "path": ["transacoes", "pix", "qrcode", "dinamico"]
            }
          }
        },
        {
          "name": "4.2 Gerar QR Code PIX Estático",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"externalId\": \"QR-STATIC-{{$randomUUID}}\",\n  \"pixKey\": \"cliente@empresateste.com\",\n  \"bankCode\": \"756\",\n  \"description\": \"QR Code estático para recebimentos\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/transacoes/pix/qrcode/estatico",
              "host": ["{{base_url}}"],
              "path": ["transacoes", "pix", "qrcode", "estatico"]
            }
          }
        },
        {
          "name": "4.3 Consultar QR Code",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/transacoes/pix/qrcode/{{qr_code_id}}",
              "host": ["{{base_url}}"],
              "path": ["transacoes", "pix", "qrcode", "{{qr_code_id}}"]
            }
          }
        },
        {
          "name": "4.4 Listar Transações PIX",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/transacoes/pix?page=1&limit=10",
              "host": ["{{base_url}}"],
              "path": ["transacoes", "pix"],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "10"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "🔗 5. INTEGRAÇÃO SICOOB",
      "item": [
        {
          "name": "5.1 Teste Conectividade Sicoob",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/integrations/sicoob/test-connectivity",
              "host": ["{{base_url}}"],
              "path": ["integrations", "sicoob", "test-connectivity"]
            }
          }
        },
        {
          "name": "5.2 Criar Cobrança PIX Sicoob",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"calendario\": {\n    \"expiracao\": 3600\n  },\n  \"devedor\": {\n    \"cpf\": \"12345678901\",\n    \"nome\": \"Cliente Teste\"\n  },\n  \"valor\": {\n    \"original\": \"100.50\"\n  },\n  \"chave\": \"cliente@empresateste.com\",\n  \"solicitacaoPagador\": \"Teste integração Sicoob PIX\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/integrations/sicoob/pix/cobranca",
              "host": ["{{base_url}}"],
              "path": ["integrations", "sicoob", "pix", "cobranca"]
            }
          }
        },
        {
          "name": "5.3 Consultar Cobrança Sicoob",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{client_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/integrations/sicoob/pix/cobranca/{{qr_code_id}}",
              "host": ["{{base_url}}"],
              "path": ["integrations", "sicoob", "pix", "cobranca", "{{qr_code_id}}"]
            }
          }
        }
      ]
    },
    {
      "name": "📊 6. CONSULTAS E RELATÓRIOS",
      "item": [
        {
          "name": "6.1 Health Check Geral",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/health",
              "host": ["{{base_url}}"],
              "path": ["health"]
            }
          }
        },
        {
          "name": "6.2 Health Check TransactionService",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/qrcode/health",
              "host": ["{{base_url}}"],
              "path": ["qrcode", "health"]
            }
          }
        },
        {
          "name": "6.3 Health Check IntegrationService",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/integrations/health",
              "host": ["{{base_url}}"],
              "path": ["integrations", "health"]
            }
          }
        }
      ]
    }
  ]
}
